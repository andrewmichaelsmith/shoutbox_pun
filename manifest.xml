<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<!--
***********************************************************************

    PunBB 1.3 Extension - online_plus
    Copyright (C) 2009  YonasH (www.yonash.pl)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see http://www.gnu.org/licenses/.

***********************************************************************
-->

<extension engine="1.0">
	<id>shoutbox_pun</id>
	<title>PunBB Shoutbox</title>
	<version>0.2.25</version>
	<description>Puts a shoutbox underneath the forum</description>
	<author>Pandog</author>

	<minversion>1.3.4</minversion>
	<maxtestedon>1.4.5</maxtestedon>
	
	<install><![CDATA[
	
	if (!$forum_db->table_exists('pun_shout'))
  {
  $schema = array(
		'FIELDS'			=> array(
  			'id'				=> array(
  				'datatype'		=> 'SERIAL',
  				'allow_null'	=> false
  			),
  			'userid'			=> array(
  				'datatype'		=> 'INT(10) UNSIGNED',
  				'allow_null'	=> false,
  				'default'		=> '0'
  			),
  			'date'			=> array(
  				'datatype'		=> 'INT(20) UNSIGNED',
  				'allow_null'	=> false,
  				'default'		=> '0'
  			),
  			'shout'			=> array(
  				'datatype'		=> 'VARCHAR(255)',
  				'allow_null'	=> false,
  				'default'		=> '\'\''
  			)
  		),
  		
  			'PRIMARY KEY'	=> array('id')
  	);
  			
  $forum_db->create_table('pun_shout', $schema);
 }	
	
	]]></install>
	
	<uninstall><![CDATA[

$forum_db->drop_table('pun_shout');

	]]></uninstall>

	
	<hooks>
		
			<hook id="hd_head"><![CDATA[
if (defined('FORUM_PAGE') && FORUM_PAGE == 'index')
{
	if (file_exists($ext_info['path'].'/style/'.$forum_user['style'].'/'.$ext_info['id'].'.css'))
		$forum_head['style_online_plus'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/style/'.$forum_user['style'].'/'.$ext_info['id'].'.css" />';
	else
		$forum_head['style_online_plus'] = '<link rel="stylesheet" type="text/css" media="screen" href="'.$ext_info['url'].'/style/Oxygen/'.$ext_info['id'].'.css" />';
}
		]]></hook>
		
		<hook id="in_info_output_start"><![CDATA[
		?>
<script type="text/javascript" src="/extensions/shoutbox_pun/jquery.js"></script>
<script language="javascript">

  var t;
  waitTime = 2000;
  lastid = 0;  
  
  $("#loading").hide();
  
    $(document).ready(function(){ 
       
		
		$("form#shoutform").submit(function(){  

				
				 $("#loading").fadeIn();
				 			 
				 $.get("/extensions/shoutbox_pun/data.php",{  add: $("#shout").val(), id: lastid }, function(xml)
				 {
				 });
				 $("#shout").attr("value","");
			     
				 
				 
				 return false;   
		 });
		 
		 updateShoutbox();
		 
		 
   });   

 
   function addMessages(xml) {
   
		   
		  
		   if($("newones",xml).text() == "0") {
				t = setTimeout("updateShoutbox()", waitTime);   
				return;
				}

			lastid = $("lastid",xml).text(); 				
		 
			$("message",xml).each(function(id) {   
			   message = $("message",xml).get(id); 
			   var d = new Date(parseInt($("date",message).text())*1000);
			   
			   var hour = d.getHours();
			   if(hour < 10) hour = "0" + hour;
			   
			   var min = d.getMinutes();
			   if(min < 10)  min = "0" + min;
				
				
			   $("#shoutbox").prepend(
							
							"<li><b title=\""+
							d.toDateString()
							+"\">["+
							hour
							+":"+
							min
							+"]</b> <b>"
							+$("username",message).text()+   
							 "</b>: "+$("text",message).text()+   
							 "</li>");
			 });
			 $("#loading").fadeOut();
			}
			 
   
		function updateShoutbox() {   
    
		$.get("/extensions/shoutbox_pun/data.php",{ m: "list", id: lastid }, function add(xml) {
		addMessages(xml)

		});   

     
   }
   

</script>

<form id="shoutform">
		<input type="text" class="sbox" id="shout" color="white" size="100" maxlength="250">
		<img src="/extensions/shoutbox_pun/loading.gif" alt="Loading..." id="loading" width="16" height="16"/>
		<span id="error"></span>
    <div class="sbox" id="sbox">
    <div id="shoutbox">
     I wish I was faster too
    </div>
    </div>
</form>
		<?php
		]]></hook>
			</hooks>
</extension>
